------------------
title: Freeモナドを活用して問題を記述する[WIP]
date: 2016-03-20
tags: [haskell]
------------------

## ここで書くこと

Haskellでここ1年くらいずーっと悩んでいた問題が少し解けてきている気がするので、その問題の捉え方と解決までの歩みについて書きます。

同じことで悩む人の参考になれば幸いです。

問題とは……

**ドメイン(問題領域)のロジックがHaskellらしく書けない** ということです。

私が思う"Haskellらしい"コード
: - 純粋なコードと副作用を持つコードが 8:2 くらいの比率で書かれている
- 型によって問題が分解されて表現されている
- fugafuga

私が思う"Haskellらしくない"コード
: - 至るところに`IO`モナドが跋扈しているコード
- 関数の中にたくさんの文脈が含まれている

### こんな人に読んでほしい

『すごいHaskellたのしく学ぼう！』を読み終わったくらいの人。

- MaybeやListモナドの存在を知っている

基本的な書き方は解ったけど何かを作ろうと思うと

### キーワード

- Free Monad
- 純粋なドメイン

### 参考にした書籍, 記事

今の理解にたどり着くまでに読んだ書籍・記事の中で特に腑に落ちたものを列挙しておきます。

[Purify code using free monads](http://www.haskellforall.com/2012/07/purify-code-using-free-monads.html)
: IOまみれになりがちなコードを純粋に保つための方法を教えてくれました

[5 Ways to Test Applications that Access a Database in Haskell](http://functor.tokyo/blog/2015-11-20-testing-db-access)
: コードを純粋に保つことでどんな恩恵があるかを教えてくれました

[Scala関数型デザイン&プログラミング](http://www.amazon.co.jp/dp/4844337769) - 13.4.1 フリーモナド
: ドメインの翻訳(translation)という考え方について教えてくれました

[【型レベルWeb DSL】 Servantの紹介](http://qiita.com/lotz/items/883b41fa79f060e59efa)
: 型を使って問題を表現することの好例を知りました

[Understanding F-Algebras](https://www.schoolofhaskell.com/user/bartosz/understanding-algebras)
: 関手をベースにドメインを体系化する方法として参考にしました

## 要点

**余計なレイヤを含まない純粋な問題領域を作る**

これに尽きます。問題領域を以降ではドメインと呼びます。

これは何を言っているかというと、DBとかJSONとかHTTPとかそういう外の世界のルールに依存したものを
徹底的に排除したデータ型の空間を作り上げることです。このデータ型の空間がドメインとなります。

極端な話、ドメインはDBやHTTPサーバ無しのREPL(ghci)だけで計算できなければなりません。
外部IOなんてもっての他です。

このぐらい潔癖にやらねば。

### ドメインをピュアに保つ恩恵

T.B.D.

### 設計上のブレイクスルー: インタフェースをデータ型として定義する

オブジェクト指向プログラミングではデータにメソッドを生やすことで手続きを記述していました。

私はこの思考から抜け出しきれずしばらく放浪していました。
結果的に起きたのはデータ型に対してどんどん増えていくバラバラの関数です。

## 今のところの設計フローメモ(T.B.D)

値を表すデータ型を定義する。(モノのエンコード)

モノ同士の関連を関数で示す。
APIを型で記述しきる - 実装は後で与える

他に仮定されている条件とかを考えるk

## 肥大化する関数

## レイヤの分離

## ドメインを純粋に保つ

## モノとコトとKind


## ダメだったやりかた
