<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Hash λ Bye - Freeモナドを活用して問題を記述する[WIP]</title>
        <link rel="stylesheet" type="text/css" href="../css/pure-nr-min.css" />
        <link rel="stylesheet" type="text/css" href="../css/font-awesome.min.css" />
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/highlight.css">

        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {inlineMath: [['\\(','\\)']]},
          processEscape: true
        });
        </script>

        <script src="../js/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </head>
    <body>
        <div class="pure-menu pure-menu-horizontal">
          <a href="../" class="brand pure-menu-heading pure-menu-link">Hash λ Bye</a>
          <ul class="pure-menu-list">
            <li class="pure-menu-item">
              <a href="../" class="pure-menu-link">Home</a>
            </li>
            <li class="pure-menu-item">
              <a href="../about.html" class="pure-menu-link"></i>About</a>
            </li>
            <li class="pure-menu-item">
              <a href="../contact.html" class="pure-menu-link">Contact</a>
            </li>
            <li class="pure-menu-item">
              <a href="../archive.html" class="pure-menu-link">Archive</a>
            </li>
          </ul>
        </div>

        <div id="content">
            <h1 class="title">Freeモナドを活用して問題を記述する[WIP]</h1>

            <div class="body">
            <div class="info">
    Posted on March 20, 2016
    
</div>

<h2 id="ここで書くこと">ここで書くこと</h2>
<p>Haskellでここ1年くらいずーっと悩んでいた問題が少し解けてきている気がするので、その問題の捉え方と解決までの歩みについて書きます。</p>
<p>同じことで悩む人の参考になれば幸いです。</p>
<p>問題とは……</p>
<p><strong>ドメイン(問題領域)のロジックがHaskellらしく書けない</strong> ということです。</p>
<dl>
<dt>私が思う“Haskellらしい”コード</dt>
<dd><ul>
<li>純粋なコードと副作用を持つコードが 8:2 くらいの比率で書かれている</li>
<li>型によって問題が分解されて表現されている</li>
<li>fugafuga</li>
</ul>
</dd>
<dt>私が思う“Haskellらしくない”コード</dt>
<dd><ul>
<li>至るところに<code>IO</code>モナドが跋扈しているコード</li>
<li>関数の中にたくさんの文脈が含まれている</li>
</ul>
</dd>
</dl>
<h3 id="こんな人に読んでほしい">こんな人に読んでほしい</h3>
<p>『すごいHaskellたのしく学ぼう！』を読み終わったくらいの人。</p>
<ul>
<li>MaybeやListモナドの存在を知っている</li>
</ul>
<p>基本的な書き方は解ったけど何かを作ろうと思うと</p>
<h3 id="キーワード">キーワード</h3>
<ul>
<li>Free Monad</li>
<li>純粋なドメイン</li>
</ul>
<h3 id="参考にした書籍-記事">参考にした書籍, 記事</h3>
<p>今の理解にたどり着くまでに読んだ書籍・記事の中で特に腑に落ちたものを列挙しておきます。</p>
<dl>
<dt><a href="http://www.haskellforall.com/2012/07/purify-code-using-free-monads.html">Purify code using free monads</a></dt>
<dd>IOまみれになりがちなコードを純粋に保つための方法を教えてくれました
</dd>
<dt><a href="http://functor.tokyo/blog/2015-11-20-testing-db-access">5 Ways to Test Applications that Access a Database in Haskell</a></dt>
<dd>コードを純粋に保つことでどんな恩恵があるかを教えてくれました
</dd>
<dt><a href="http://www.amazon.co.jp/dp/4844337769">Scala関数型デザイン&amp;プログラミング</a> - 13.4.1 フリーモナド</dt>
<dd>ドメインの翻訳(translation)という考え方について教えてくれました
</dd>
<dt><a href="http://qiita.com/lotz/items/883b41fa79f060e59efa">【型レベルWeb DSL】 Servantの紹介</a></dt>
<dd>型を使って問題を表現することの好例を知りました
</dd>
<dt><a href="https://www.schoolofhaskell.com/user/bartosz/understanding-algebras">Understanding F-Algebras</a></dt>
<dd>関手をベースにドメインを体系化する方法として参考にしました
</dd>
</dl>
<h2 id="要点">要点</h2>
<p><strong>余計なレイヤを含まない純粋な問題領域を作る</strong></p>
<p>これに尽きます。問題領域を以降ではドメインと呼びます。</p>
<p>何を言っているかというと、DBとかJSONとかHTTPとかそういう外の世界のルールに依存したものを 徹底的に排除したデータ型の空間を作り上げることです。このデータ型の空間がドメインとなります。</p>
<p>ドメインが外部作用に一切依存しないように設計します。 従来はドメインとインフラが垂直に統合されており、インタフェースの実装をDIで与えることで</p>
<h3 id="垂直的な関係による依存">垂直的な関係による依存</h3>
<pre><code>Application
↓
Domain
↓
Infrastructure</code></pre>
<h3 id="水平的な関係による変換">水平的な関係による変換</h3>
<pre><code>Application → Domain → Infrastructure</code></pre>
<h3 id="ドメインをピュアに保つ恩恵">ドメインをピュアに保つ恩恵</h3>
<p>T.B.D.</p>
<h3 id="設計上のブレイクスルー">設計上のブレイクスルー</h3>
<h4 id="その1-インタフェースをデータ型として定義する">その1 インタフェースをデータ型として定義する</h4>
<p>オブジェクト指向プログラミングではデータにメソッドを生やすことで手続きを記述していました。</p>
<p>私はこの思考から抜け出しきれずしばらく放浪していました。</p>
<p>そのため構造体のようなレコードとメソッドの代わりとなる関数をひたすら書いていました。 結果的に起きたのはデータ型に対してどんどん増えていくバラバラの関数です。</p>
<p>それぞれの関数の型注釈はそこそこ上手く事前条件と事後条件を表しているのです。 しかしそれらがバラバラと増えていくと目的のために必要な関数を見つけるのにもだんだん苦労するようになってきます。</p>
<h4 id="その2-理想化する">その2 理想化する</h4>
<p>T.B.D.</p>
<h2 id="今のところの設計フローメモt.b.d">今のところの設計フローメモ(T.B.D)</h2>
<ul>
<li>値を表すデータ型を定義する(モノのエンコード)</li>
<li>ユースケースをドメイン内のイベントとして記述しきる(コトのエンコード) ユースケースは複数の操作に分解できるので、それらは後回し</li>
<li>プリミティブを作る プリミティブを合成してユースケースを作ると考える</li>
<li>プリミティブを組み合わせてドメインのユースケースを作る</li>
<li>specを書いて使い方をつかむ</li>
</ul>
<h2 id="肥大化する関数">肥大化する関数</h2>
<h2 id="レイヤの分離">レイヤの分離</h2>
<h2 id="ドメインを純粋に保つ">ドメインを純粋に保つ</h2>
<h2 id="モノとコトとkind">モノとコトとKind</h2>
<h2 id="ダメだったやりかた">ダメだったやりかた</h2>

            </div>
        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
